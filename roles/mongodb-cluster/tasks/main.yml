---
# This role deploys the mongodb processes and sets up settings.

- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"
  tags:
    - mongodb-cluster

- include_tasks: setup-RedHat.yml
  when: ansible_os_family == 'RedHat'

- include_tasks: setup-Debian.yml
  when: ansible_os_family == 'Debian'

- name: Create Directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ mongodb_user }}"
    group: "{{ mongodb_group }}"
  with_items:
    - "{{ mongodb_cs_dbpath }}"
    - "{{ mongodb_cs_logpath }}"
    - "{{ mongodb_cs_pidfilepath }}"
    - "{{ mongodb_qr_logpath }}"
    - "{{ mongodb_sn_dbpath }}"
    - "{{ mongodb_sn_logpath  }}"
    - "{{ mongodb_sn_pidfilepath }}"
  tags:
    - mongodb-cluster

## Config Server
- name: Copy Config Server Configuration File
  template:
    src: mongod-cs.conf.j2
    dest: "{{ mongodb_cs_config_file }}"
    owner: root
    group: root
    mode: 0644
    force: yes
  notify: restart mongod-cs
  tags:
    - mongodb-cluster

- name: Copy Config Server Systemd Service
  template:
    src: mongod-cs.service.j2
    dest: /etc/systemd/system/mongod-cs.service
    owner: root
    group: root
    mode: 0644
    force: yes
  notify: reload systemd config

- name: Start MongoDB Config Server
  service:
    name: mongod-cs
    state: started
    enabled: yes
  tags:
    - mongodb-cluster

## Query Router
- name: Copy Query Router Configuration File
  template:
    src: mongos-qr.conf.j2
    dest: "{{ mongodb_qr_config_file }}"
    owner: root
    group: root
    mode: 0644
    force: yes
  notify: restart mongos-qr
  tags:
    - mongodb-cluster

- name: Copy Query Router Systemd Service
  template:
    src: mongos-qr.service.j2
    dest: /etc/systemd/system/mongos-qr.service
    owner: root
    group: root
    mode: 0644
    force: yes
  notify: reload systemd config

- name: Start MongoDB Query Router
  service:
    name: mongos-qr
    state: started
    enabled: yes
  tags:
    - mongodb-cluster

## Shard Node
- name: Copy Shard Node Configuration File
  template:
    src: mongod-sn.conf.j2
    dest: "{{ mongodb_sn_config_file }}"
    owner: root
    group: root
    mode: 0644
    force: yes
  notify: restart mongod-sn
  tags:
    - mongodb-cluster

- name: Copy Shard Node Systemd Service
  template:
    src: mongod-sn.service.j2
    dest: /etc/systemd/system/mongod-sn.service
    owner: root
    group: root
    mode: 0644
    force: yes
  notify: reload systemd config

- name: Start MongoDB Shard Node
  service:
    name: mongod-sn
    state: started
    enabled: yes
  tags:
    - mongodb-cluster

