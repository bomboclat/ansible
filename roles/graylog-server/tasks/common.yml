---

- name: Install required packages
  package:
     name: "{{ item }}"
     state: present
  with_items:
    - tuned
    - epel-release

- name: Make folder for profile no-thp
  file:
     name: /etc/tuned/no-thp
     state: directory
     owner: root
     group: root

- name: Copy no-thp profile's File
  copy:
    src: '{{ item.src }}'
    dest: '/etc/tuned/no-thp'
    owner: root
    group: root
    mode: 0755
  with_filetree:
      - 'files/no-thp'

- name: Check tuned active profile
  shell: |
    set -o pipefail
    tuned-adm active | awk -F': ' '{print $2}'
  register: tuned_active_profile
  changed_when: false

- name: Start no-thp profile
  command: 'tuned-adm profile no-thp'
  when:
    - tuned_active_profile.stdout != 'no-thp'

- name: Set sysctl swappiness
  sysctl:
    name: vm.swappiness
    value: 20
    state: present
    reload: yes
    sysctl_set: yes

- name: Set sysctl tcp keepalive
  sysctl:
    name: net.ipv4.tcp_keepalive_time
    value: 300
    state: present

- name: "Build hosts file for main graylog groups"
  lineinfile:
    dest: /etc/hosts
    regexp: "^{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}$"
    line: "{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}"
    state: present
  with_items:
    - "{{ groups['graylog'] }}"
    - "{{ groups['graylog_backend'] }}"
